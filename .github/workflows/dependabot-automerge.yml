name: Dependency auto-merge
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
  schedule:
    - cron: "0 23 * * *" # 23:00 UTC daily (00:00 in UTC+1, 01:00 in UTC+2)
permissions:
  contents: read
  pull-requests: write
concurrency:
  group: dependency-rollup
  cancel-in-progress: true
env:
  GH_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
  BASE_BRANCH: ${{ github.event.repository.default_branch }}
jobs:
  automerge:
    if: github.event_name != 'pull_request' || github.actor == 'dependabot[bot]' || github.actor == 'renovate[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Build combined dependency branch
        id: rollup
        shell: bash
        run: |
          set -euo pipefail
          prs="$(gh api --paginate "repos/${{ github.repository }}/pulls?state=open&per_page=100" --jq '.[] | select((.user.login=="dependabot[bot]" or .user.login=="renovate[bot]") and .head.ref!="deps/rollup") | "\(.number):\(.head.ref)"')"
          if [ -z "$prs" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          rollup_branch="deps/rollup"
          git checkout -B "$rollup_branch" "origin/$BASE_BRANCH"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          for pr in $prs; do
            pr_number="${pr%%:*}"
            head_ref="${pr#*:}"
            git fetch origin "$head_ref"
            if git merge --squash --no-commit FETCH_HEAD; then
              if git diff --cached --quiet; then
                continue
              fi
              git commit -m "chore(deps): include #$pr_number"
            else
              git merge --abort || true
              echo "::warning::Skipping dependency PR #$pr_number due to merge conflicts."
            fi
          done
          if git diff --quiet "origin/$BASE_BRANCH" HEAD; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if git push --force-with-lease origin "$rollup_branch"; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "rollup_branch=$rollup_branch" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::Failed to push rollup branch '$rollup_branch'."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
      - name: Create or update rollup PR
        if: steps.rollup.outputs.has_changes == 'true'
        id: upsert_pr
        shell: bash
        run: |
          set -euo pipefail
          branch="${{ steps.rollup.outputs.rollup_branch }}"
          pr_number="$(gh pr list --head "$branch" --base "$BASE_BRANCH" --json number --jq '.[0].number // ""')"
          if [ -z "$pr_number" ]; then
            pr_url="$(gh pr create \
              --base "$BASE_BRANCH" \
              --head "$branch" \
              --title "chore(deps): roll up dependabot and renovate updates" \
              --body "This PR combines all open Dependabot and Renovate updates into one branch for a single squash merge.")"
            pr_number="${pr_url##*/}"
          else
            gh pr edit "$pr_number" \
              --title "chore(deps): roll up dependabot and renovate updates" \
              --body "This PR combines all open Dependabot and Renovate updates into one branch for a single squash merge."
          fi
          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"
      - name: Enable auto squash merge for rollup PR
        if: steps.rollup.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -euo pipefail
          pr_number="${{ steps.upsert_pr.outputs.pr_number }}"
          if [ -n "$pr_number" ]; then
            if ! gh pr merge "$pr_number" --auto --squash; then
              status=$?
              echo "::warning::Failed to enable auto-merge for PR #$pr_number (exit $status)."
            fi
          fi
